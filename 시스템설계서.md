# 시스템 설계서

## 1. 개요

### 1.1 시스템의 목표
경부고속도로 오산IC-천안IC 구간의 실시간 교통 데이터를 수집하고 분석하여, AI 기반 교통 예측 서비스를 제공함으로써 운전자의 안전하고 효율적인 도로 이용을 지원한다. 또한 CCTV 영상, 돌발상황, 취약구간 등 안전정보를 통합 제공하여 교통사고를 예방하고 교통 흐름의 효율성을 향상시킨다.

### 1.2 시스템의 환경
- **통신망**: 인터넷 통신망을 기반으로 하며, ITS Open API와의 HTTPS 통신을 전제로 함
- **서버 컴퓨터**: Node.js 및 Python 실행 환경을 지원하는 서버급 컴퓨터 (동시 사용자 50명 이상 처리 가능)
- **O/S 및 언어**:
  - 백엔드: Node.js (JavaScript), Python 3.7+
  - 프론트엔드: HTML5, CSS3, Vanilla JavaScript
- **데이터 저장소**: CSV 파일 기반 (history.csv, 안개취약.csv, 결빙구간.csv)
- **외부 API**: ITS Open API (한국도로공사), 행정안전부 공공데이터

### 1.3 시스템의 범위
**실시간 교통정보 수집 및 제공**
- ITS Open API를 통한 교통속도, CCTV 영상, 돌발상황, VMS 전광판 정보 수집
- 30초 주기 자동 갱신을 통한 실시간 교통 모니터링
- Leaflet.js 기반 인터랙티브 지도 제공

**AI 기반 교통 예측 시스템**
- XGBoost 모델을 활용한 1시간 후 교통속도 예측
- 11,004건의 교통 데이터 학습
- 향후 12시간 교통 예보 생성
- 위험도 분석 (원활/서행/정체)

**안전정보 통합 제공**
- 돌발상황 정보 (차량 고장, 사고 등)
- 취약구간 정보 (안개, 결빙)
- VMS 전광판 메시지
- 위험물질 운송차량 위치

**데이터 시각화**
- Chart.js를 활용한 교통 예측 차트
- 지도 기반 실시간 교통 상황 표시

### 1.4 참고자료 및 문서
- 시스템정의서
- ARCHITECTURE.md
- SYSTEM_DESIGN.md
- ITS Open API 문서

---

## 2. 시스템의 구조

### 2.1 시스템 구조도

#### 1) 구조도

```
┌─────────────────────────────────────────────────────────────────┐
│                      사용자 (웹 브라우저)                        │
│                   - Chrome / Firefox / Safari                  │
└────────────────────────────┬────────────────────────────────────┘
                             │ HTTP/REST API
                             │
┌────────────────────────────▼────────────────────────────────────┐
│              경부고속도로 실시간 교통정보 시스템                 │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │          프레젠테이션 계층 (Presentation Layer)            │ │
│  │  ┌──────────────┬──────────────┬──────────────────────┐   │ │
│  │  │ index.html   │  style.css   │   script.js          │   │ │
│  │  │ - UI 구조    │  - 스타일    │   - 클라이언트 로직  │   │ │
│  │  │ - 섹션 관리  │  - 레이아웃  │   - API 호출         │   │ │
│  │  │              │              │   - 지도/차트 렌더링 │   │ │
│  │  └──────────────┴──────────────┴──────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │          애플리케이션 계층 (Application Layer)             │ │
│  │  ┌────────────────────────────────────────────────────┐   │ │
│  │  │              Express.js 서버 (server.js)           │   │ │
│  │  │  ┌──────────────────────────────────────────────┐ │   │ │
│  │  │  │           API 라우터                         │ │   │ │
│  │  │  │  /api/traffic    /api/cctv/list             │ │   │ │
│  │  │  │  /api/predict    /api/warnings              │ │   │ │
│  │  │  │  /api/vms        /api/vulnerable            │ │   │ │
│  │  │  │  /api/dangerous  /api/events                │ │   │ │
│  │  │  └──────────────────────────────────────────────┘ │   │ │
│  │  └────────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │           AI/분석 계층 (AI/Analytics Layer)               │ │
│  │  ┌────────────────────────────────────────────────────┐   │ │
│  │  │         Python AI 서버 (ai_server.py)              │   │ │
│  │  │  - XGBoost 교통 예측 모델                          │   │ │
│  │  │  - pandas 데이터 처리                              │   │ │
│  │  │  - 11,004건 학습 데이터                            │   │ │
│  │  │  - 12시간 예보 생성                                │   │ │
│  │  └────────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │              데이터 계층 (Data Layer)                      │ │
│  │  ┌─────────────────────┬──────────────────────────────┐   │ │
│  │  │  CSV 파일           │  외부 API                    │   │ │
│  │  │  - history.csv      │  - ITS Open API              │   │ │
│  │  │  - 안개취약.csv     │  - 행정안전부 공공데이터     │   │ │
│  │  │  - 결빙구간.csv     │                              │   │ │
│  │  └─────────────────────┴──────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘
```

#### 2) 설계요소의 설명

**(1) 실시간 교통 모니터링 서브시스템**

**교통속도 조회 블록**
- ITS Open API 또는 history.csv 파일에서 현재 요일/시간대 교통속도 데이터 조회
- 구간별 (오산IC, 입장휴게소, 천안IC) 평균 속도 계산
- 30초마다 자동 갱신

**지도 시각화 블록**
- Leaflet.js를 활용한 OpenStreetMap 기반 지도 렌더링
- 구간별 CCTV 위치 마커 표시 (속도에 따라 색상 구분: 녹색/노란색/빨간색)
- 마커 클릭 시 상세 정보 팝업 표시

**(2) AI 교통 예측 서브시스템**

**AI 모델 학습 블록**
- history.csv 파일에서 11,004건의 교통 데이터 로드
- XGBoost 회귀 모델 생성 및 학습 (입력: 요일, 시간 / 출력: 속도)

**교통 예측 블록**
- 현재 시간 기준 1시간 후 교통속도 예측
- 향후 12시간 교통 예보 생성
- 위험도 계산 (40 km/h 미만: 정체, 40-80: 서행, 80 이상: 원활)

**예측 결과 시각화 블록**
- Chart.js 라인 차트를 활용한 12시간 예보 그래프
- 평소 평균 속도와 현재 예측 속도 비교

**(3) CCTV 영상 스트리밍 서브시스템**

**CCTV 목록 조회 블록**
- ITS Open API를 통한 오산IC-천안IC 구간 CCTV 목록 조회
- CCTV명, 스트리밍 URL, 위도/경도 정보 반환

**영상 재생 블록**
- HTML5 `<video>` 태그를 통한 실시간 스트리밍
- CORS 정책 처리 및 에러 핸들링

**(4) 안전정보 제공 서브시스템**

**돌발상황 조회 블록**
- ITS Open API의 posIncidentInfo 호출
- 차량 고장, 사고 등 실시간 돌발상황 정보 제공

**취약구간 조회 블록**
- 안개취약.csv: 경부고속도로 200-320km 구간 필터링
- 결빙구간.csv: 위도 36.8-37.3, 경도 126.9-127.3 범위 필터링

**VMS 전광판 조회 블록**
- ITS Open API의 vmsInfo 호출
- 전광판 메시지 및 위치 정보 제공

**위험물질 차량 조회 블록**
- ITS Open API의 dangerousCarInfo 호출
- 위험물질 운송차량 위치 및 속도 정보 제공

**(5) 시스템운영 관리 서브시스템**

**API 통신 관리 블록**
- axios를 활용한 HTTP 클라이언트
- HTTPS Agent를 통한 SSL 인증서 처리
- 타임아웃 설정 (10초)

**데이터 인코딩 관리 블록**
- iconv-lite를 활용한 EUC-KR ↔ UTF-8 변환

**에러 처리 블록**
- try-catch를 통한 전역 에러 핸들링
- API 실패 시 빈 배열 반환

---

### 2.2 동작구조도 (데이터 플로우)

#### 1) 실시간 교통 조회 플로우

```
사용자 → [웹 브라우저 로드]
         ↓
       [script.js 초기화]
         ↓
       [setInterval 30초 타이머 시작]
         ↓
       [GET /api/traffic 호출] → Express 서버
                                    ↓
                                  [history.csv 읽기]
                                    ↓
                                  [현재 요일/시간 필터링]
                                    ↓
                                  [구간별 평균 속도 계산]
                                    ↓
                                  [JSON 응답 반환]
         ↓
       [지도 마커 업데이트]
         ↓
       [30초 대기 후 반복]
```

#### 2) AI 예측 플로우

```
사용자 → [CCTV 선택: 오산IC]
         ↓
       [GET /api/predict?id=0 호출] → Express 서버
                                        ↓
                                      [Python Child Process 생성]
                                        ↓
                                      [ai_server.py 실행] → Python AI 서버
                                                              ↓
                                                            [history.csv 로드]
                                                              ↓
                                                            [XGBoost 모델 학습]
                                                              ↓
                                                            [1시간 후 속도 예측]
                                                              ↓
                                                            [12시간 예보 생성]
                                                              ↓
                                                            [위험도 계산]
                                                              ↓
                                                            [JSON 출력 (stdout)]
                                        ↓
                                      [stdout 캡처 및 JSON 파싱]
                                        ↓
                                      [JSON 응답 반환]
         ↓
       [AI 분석 결과 표시]
         ↓
       [Chart.js 차트 렌더링]
```

#### 3) 안전정보 조회 플로우

```
사용자 → [안전정보 탭 선택: 돌발상황]
         ↓
       [GET /api/warnings 호출] → Express 서버
                                     ↓
                                   [ITS API: posIncidentInfo 호출]
                                     ↓
                                   [HTTPS 요청 (SSL Agent)]
                                     ↓
                                   [EUC-KR → UTF-8 변환]
                                     ↓
                                   [JSON 파싱 및 가공]
                                     ↓
                                   [JSON 응답 반환]
         ↓
       [돌발상황 목록 렌더링]
```

---

## 3. 데이터베이스 설계

### 3.1 데이터 구조도 (CSV 파일 기반)

```
┌─────────────────────────────────────────────────────────────┐
│                        데이터 저장소                         │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │           history.csv (교통 속도 히스토리)         │    │
│  │  - 컬럼: section_id, date, day, hour, speed       │    │
│  │  - 레코드: 11,004건                                │    │
│  │  - 용도: AI 모델 학습, 현재 속도 조회              │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │           안개취약.csv (안개 취약구간)              │    │
│  │  - 컬럼: 도로명, km범위, 구간명                    │    │
│  │  - 용도: 안개 취약구간 정보 제공                   │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │  행정안전부_상습 결빙구간.csv (결빙 취약구간)       │    │
│  │  - 컬럼: 연번, 시도, 시군구, 지역, 도로명,         │    │
│  │          시작위도, 시작경도 등                      │    │
│  │  - 용도: 결빙 취약구간 정보 제공                   │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 테이블 설명

#### 1) history.csv (교통 속도 히스토리)

| 필드명 | 자료 유형 | 자료 크기 | 비고 |
|--------|----------|----------|------|
| section_id | 정수 | 1 | 0:천안, 1:입장, 2:오산 |
| date | 문자열 | 10 | YYYY-MM-DD 형식 |
| day | 정수 | 1 | 0:월 ~ 6:일 |
| hour | 정수 | 2 | 0 ~ 23 |
| speed | 정수 | 3 | km/h (10~120) |

**예시 데이터:**
```
2,2024-10-15,3,14,95
0,2024-10-15,3,14,85
1,2024-10-15,3,14,88
```

#### 2) 안개취약.csv (안개 취약구간)

| 필드명 | 자료 유형 | 자료 크기 | 비고 |
|--------|----------|----------|------|
| 도로명 | 문자열 | 20 | 경부고속도로 |
| km범위 | 문자열 | 10 | 245~247km |
| 구간명 | 문자열 | 30 | 오산IC 부근 |

#### 3) 행정안전부_상습 결빙구간.csv (결빙 취약구간)

| 필드명 | 자료 유형 | 자료 크기 | 비고 |
|--------|----------|----------|------|
| 연번 | 정수 | 5 | 일련번호 |
| 시도 | 문자열 | 10 | 경기도 |
| 시군구 | 문자열 | 10 | 화성시 |
| 지역 | 문자열 | 20 | 오산시 |
| 도로명 | 문자열 | 30 | 경부고속도로 |
| 시작위도 | 실수 | 10 | 37.1234 |
| 시작경도 | 실수 | 10 | 127.0567 |

**필터링 조건:** 위도 36.8~37.3, 경도 126.9~127.3

---

## 4. 사용자 인터페이스 설계

### 4.1 사용자 인터페이스 절차

```
┌─────────────────────────────────────────────────────────────┐
│                      메인 화면 (index.html)                 │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────┐    │
│  │                    헤더 영역                        │    │
│  │  [🚗 경부고속도로 교통정보]          [00:00:00]   │    │
│  │  [홈] [실시간 교통] [CCTV] [안전정보]              │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │                  컨텐츠 영역                        │    │
│  │  (선택된 섹션에 따라 동적으로 변경)                │    │
│  └────────────────────────────────────────────────────┘    │
│                                                              │
│  ┌────────────────────────────────────────────────────┐    │
│  │                    푸터 영역                        │    │
│  │  © 경부고속도로 실시간 교통정보 시스템             │    │
│  └────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────┘

         ↓ 사용자 메뉴 선택에 따른 화면 전환

┌──────────┬──────────┬──────────┬──────────┐
│   홈     │ 실시간   │  CCTV    │ 안전정보 │
│          │  교통    │          │          │
└────┬─────┴────┬─────┴────┬─────┴────┬─────┘
     │          │          │          │
     ↓          ↓          ↓          ↓
┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐
│ 홈 섹션 │ │ 지도    │ │ CCTV    │ │ 안전    │
│         │ │ 섹션    │ │ 섹션    │ │ 섹션    │
│ - 현황  │ │         │ │         │ │         │
│   카드  │ │ - 지도  │ │ - 영상  │ │ - 돌발  │
│ - AI    │ │ - 마커  │ │ - AI    │ │ - 취약  │
│   차트  │ │ - 제어  │ │   분석  │ │ - VMS   │
└─────────┘ └─────────┘ └─────────┘ └─────────┘
```

### 4.2 사용자 인터페이스 양식

#### 1) 홈 섹션 (home-section)

```
┌─────────────────────────────────────────────────────────────┐
│                실시간 교통 상황 모니터링                     │
│         AI 기반 교통 예측 및 CCTV 분석 시스템               │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│  │ 현재도로│ │ 예상소요│ │ 도로안전│ │ 현재주의│          │
│  │ 상황    │ │ 시간    │ │ 지수    │ │ 정보    │          │
│  │         │ │         │ │         │ │         │          │
│  │ 95 km/h │ │ 45분    │ │ 85점    │ │ 3건     │          │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘          │
├─────────────────────────────────────────────────────────────┤
│              AI 교통 예측 정보 (12시간)                     │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                      │   │
│  │  100 ┤                                              │   │
│  │   90 ┤  ●─●─●                                       │   │
│  │   80 ┤         ●─●                                  │   │
│  │   70 ┤             ●─●                              │   │
│  │   60 ┤                 ●─●                          │   │
│  │      └──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──┬──         │   │
│  │        14 15 16 17 18 19 20 21 22 23 00 01 (시)   │   │
│  │                                                      │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

#### 2) 실시간 교통 섹션 (traffic-section)

```
┌─────────────────────────────────────────────────────────────┐
│                     실시간 교통 모니터링                     │
├─────────────────────────────────────────────────────────────┤
│  지도 컨트롤:                                               │
│  ☑ 돌발상황 표시  ☑ VMS 표시  ☑ 위험물질 차량             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                      │   │
│  │              [Leaflet.js 지도 영역]                 │   │
│  │                                                      │   │
│  │     ● 오산IC (95 km/h) - 녹색                       │   │
│  │                                                      │   │
│  │     ● 입장휴게소 (88 km/h) - 녹색                   │   │
│  │                                                      │   │
│  │     ● 천안IC (85 km/h) - 노란색                     │   │
│  │                                                      │   │
│  │     ⚠️ 돌발상황 위치 표시                            │   │
│  │                                                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  범례: ● 녹색 (80+ km/h)  ● 노란색 (40-80)  ● 빨간색 (<40)│
└─────────────────────────────────────────────────────────────┘
```

#### 3) CCTV 섹션 (cctv-section)

```
┌─────────────────────────────────────────────────────────────┐
│                        CCTV 실시간 영상                      │
├─────────────────────────────────────────────────────────────┤
│  CCTV 선택: [오산IC ▼]                                      │
├─────────────────────────────────────────────────────────────┤
│  ┌────────────────────┐  ┌─────────────────────────────┐   │
│  │                    │  │    AI 분석 결과              │   │
│  │   CCTV 영상 영역   │  │                              │   │
│  │                    │  │  위험도: 🟩 원활 예상        │   │
│  │   [LIVE STREAM]    │  │  예측 속도: 85 km/h          │   │
│  │                    │  │  1시간 후 예상 (15시 기준)   │   │
│  │   [비디오 재생기]  │  │                              │   │
│  │                    │  │  평소 패턴 분석              │   │
│  │                    │  │  ─────────────────           │   │
│  │                    │  │  평소 평균: 92 km/h          │   │
│  │                    │  │  현재: 평소보다 7 km/h 느림  │   │
│  │                    │  │                              │   │
│  └────────────────────┘  │  향후 12시간 예보            │   │
│                           │  [Chart.js 라인 차트]        │   │
│                           └─────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

#### 4) 안전정보 섹션 (info-section)

```
┌─────────────────────────────────────────────────────────────┐
│                         안전 정보                            │
├─────────────────────────────────────────────────────────────┤
│  [돌발상황] [취약구간] [VMS] [위험물질 차량]                │
├─────────────────────────────────────────────────────────────┤
│  📍 돌발상황 (3건)                                          │
│  ───────────────────────────────────────────────────        │
│  ⚠️ 차량 고장 - 오산IC 부근 (37.1234, 127.0567)            │
│  🚧 공사 - 천안IC 진입로 (36.8456, 127.1823)               │
│  🔥 화재 - 입장휴게소 (37.0123, 127.1100)                   │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 5. 구현상의 고려사항

### 프론트엔드
- Vanilla JavaScript 사용으로 프레임워크 의존성 최소화
- Leaflet.js 및 Chart.js 라이브러리 CDN 방식으로 로드
- 30초 주기 setInterval을 활용한 자동 갱신 (메모리 누수 방지를 위해 clearInterval 필수)
- 반응형 디자인 적용 (최소 해상도 1280x720)

### 백엔드
- Express.js 기반 RESTful API 설계
- HTTPS Agent를 통한 SSL 인증서 처리 (개발 환경: rejectUnauthorized: false)
- iconv-lite를 활용한 EUC-KR ↔ UTF-8 인코딩 변환
- try-catch를 통한 전역 에러 핸들링

### AI 모델
- Python Child Process 방식으로 실행 (spawn 사용)
- XGBoost 모델의 경량화 (n_estimators=100, max_depth=5)
- 새벽 시간대 데이터 부족 문제 해결을 위한 보정 로직 적용
- stdout을 통한 JSON 출력 방식

### 데이터 관리
- CSV 파일 기반 데이터 저장 (향후 MySQL/MongoDB 전환 고려)
- fs.readFileSync를 활용한 동기 방식 파일 읽기
- 데이터 필터링 및 가공은 서버 측에서 처리

### 성능 최적화
- API 타임아웃 설정 (10초)
- 불필요한 API 호출 최소화 (캐싱 고려)
- 지도 렌더링 최적화 (마커 클러스터링은 향후 적용 검토)

---

## 6. 시험 계획

### 6.1 단위 시험
**각 API 엔드포인트별 단위 시험 (Postman 또는 curl 활용)**
- `/api/traffic`: 교통속도 데이터 정상 반환 확인
- `/api/predict`: AI 예측 결과 정상 생성 확인
- `/api/cctv/list`: CCTV 목록 조회 확인
- `/api/warnings`, `/api/vms`, `/api/vulnerable`, `/api/dangerous`: 안전정보 조회 확인

**Python AI 서버 단독 시험 (명령줄에서 직접 실행)**
- 입력값: day, hour, section_id
- 출력값: JSON 형식 검증

### 6.2 통합시험
**프론트엔드 ↔ 백엔드 API 통신 시험**
- 30초 자동 갱신 정상 동작 확인
- 네트워크 에러 발생 시 에러 핸들링 확인

**백엔드 ↔ Python AI 서버 통신 시험**
- Child Process 생성 및 종료 정상 동작 확인
- stdout 파싱 오류 처리 확인

**백엔드 ↔ ITS Open API 통신 시험**
- SSL 인증서 처리 확인
- 타임아웃 처리 확인
- EUC-KR 인코딩 변환 확인

### 6.3 시스템 시험
**기능 시험**
- 실시간 교통 모니터링 기능: 지도 로드, 마커 표시, 색상 구분, 팝업 표시
- AI 교통 예측 기능: CCTV 선택, 예측 결과 표시, 차트 렌더링
- CCTV 영상 스트리밍 기능: 영상 재생, CORS 에러 처리
- 안전정보 제공 기능: 돌발상황, 취약구간, VMS, 위험물질 차량 정보 표시

**사용자 시나리오 시험**
- 시나리오 1: 사용자가 홈 → 실시간 교통 → CCTV → 안전정보 순서로 탐색
- 시나리오 2: 사용자가 특정 CCTV 선택 후 AI 예측 결과 확인
- 시나리오 3: 사용자가 안전정보 탭에서 돌발상황 및 취약구간 확인

**성능 시험**
- 동시 사용자 10명 접속 시 응답 시간 측정
- API 응답 시간 측정 (평균 2초 이내 목표)
- 메모리 누수 확인 (장시간 실행 시험)

**브라우저 호환성 시험**
- Chrome, Firefox, Safari, Edge에서 정상 동작 확인

### 6.4 인수 시험
**사용자 인수 시험**
- 실제 운전자 5명을 대상으로 사용성 평가
- 피드백 수집 및 UI/UX 개선사항 도출

**성능 인수 시험**
- 목표 성능 지표 달성 여부 확인 (응답 시간 2초 이내, 동시 사용자 50명)